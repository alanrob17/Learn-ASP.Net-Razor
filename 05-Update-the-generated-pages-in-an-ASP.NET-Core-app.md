# Update the generated pages in an ASP.NET Core app

The scaffolded movie app has a good start, but the presentation isn't ideal. In the Index page, ``ReleaseDate`` should be two words, ``Release Date``.

## Update the model

Update ``Models/Movie.cs`` with the following code:

```bash
    public class Movie
    {
        public int Id { get; set; }
        public string? Title { get; set; }

        [Display(Name = "Release Date")]
        [DataType(DataType.Date)]
        public DateTime ReleaseDate { get; set; }
        public string? Genre { get; set; }

        [Column(TypeName = "decimal(18, 2)")]
        public decimal Price { get; set; }
    }
```

In the previous code:

The ``[Column(TypeName = "decimal(18, 2)")]`` data annotation enables Entity Framework Core to correctly map ``Price`` to currency in the database. For more information, see [Data Types](https://learn.microsoft.com/en-us/ef/core/modeling/relational/data-types).

The [[Display]](https://learn.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations.displayattribute) attribute specifies the display name of a field. In the preceding code, ``Release Date`` instead of ``ReleaseDate``.

The [[DataType]](https://learn.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations.datatypeattribute) attribute specifies the type of the data (``Date``). The time information stored in the field isn't displayed.

Browse to ``Pages/Movies`` and hover over an Edit link to see the target URL. For example a particular link is.

> https://localhost:7082/Movies/Edit?id=7

The **Edit**, **Details**, and **Delete** links are generated by the [Anchor Tag Helper](https://learn.microsoft.com/en-us/aspnet/core/mvc/views/tag-helpers/built-in/anchor-tag-helper?view=aspnetcore-9.0) in the ``Pages/Movies/Index.cshtml`` file.

```bash
    <a asp-page="./Edit" asp-route-id="@item.Id">Edit</a> |
    <a asp-page="./Details" asp-route-id="@item.Id">Details</a> |
    <a asp-page="./Delete" asp-route-id="@item.Id">Delete</a>
```

``Tag Helpers`` enable server-side code to participate in creating and rendering HTML elements in Razor files.

In the preceding code, the ``Anchor Tag Helper`` dynamically generates the HTML ``href`` attribute value from the Razor Page (the route is relative), the ``asp-page``, and the route identifier (``asp-route-id``). For more information, see [URL generation for Pages](https://learn.microsoft.com/en-us/aspnet/core/razor-pages/?view=aspnetcore-9.0#url-generation-for-pages).

Use **View Source** from a browser to examine the generated markup. A portion of the generated HTML is shown below:

```bash
    <td>
      <a href="/Movies/Edit?id=1">Edit</a> |
      <a href="/Movies/Details?id=1">Details</a> |
      <a href="/Movies/Delete?id=1">Delete</a>
    </td>
```

The dynamically generated links pass the movie ``ID`` with a query string. For example, the ``?id=1`` in ``https://localhost:5001/Movies/Details?id=1``.

## Add route template

Update the **Edit**, **Details**, and **Delete** Razor Pages to use the ``{id:int}`` route template. Change the page directive for each of these pages from ``@page`` to ``@page "{id:int}"``. Run the app and then view source.

The generated HTML adds the ID to the path portion of the URL:

```bash
    <td>
      <a href="/Movies/Edit/1">Edit</a> |
      <a href="/Movies/Details/1">Details</a> |
      <a href="/Movies/Delete/1">Delete</a>
    </td>
```

A request to the page with the ``{id:int}`` route template that does not include the integer returns an HTTP 404 (not found) error. For example, ``https://localhost:5001/Movies/Details`` returns a 404 error. To make the ``ID`` optional, append ``?`` to the route constraint:

Test the behavior of ``@page "{id:int?}``":

Set the page directive in ``Pages/Movies/Details.cshtml`` to ``@page "{id:int?}``".

Set a break point in public async ``Task<IActionResult> OnGetAsync(int? id)``, in ``Pages/Movies/Details.cshtml.cs``.

Navigate to ``https://localhost:5001/Movies/Details/``.

With the ``@page "{id:int}"`` directive, the break point is never hit. The routing engine returns HTTP 404. Using ``@page "{id:int?}``", the ``OnGetAsync`` method returns ``NotFound`` (HTTP 404):

## Review concurrency exception handling

Review the ``OnPostAsync`` method in the ``Pages/Movies/Edit.cshtml.cs`` file:

```bash
public async Task<IActionResult> OnPostAsync()
{
    if (!ModelState.IsValid)
    {
        return Page();
    }

    _context.Attach(Movie).State = EntityState.Modified;

    try
    {
        await _context.SaveChangesAsync();
    }
    catch (DbUpdateConcurrencyException)
    {
        if (!MovieExists(Movie.Id))
        {
            return NotFound();
        }
        else
        {
            throw;
        }
    }

    return RedirectToPage("./Index");
}

private bool MovieExists(int id)
{
    return _context.Movie.Any(e => e.Id == id);
}
```

The previous code detects concurrency exceptions when one client deletes the movie and the other client posts changes to the movie.

To test the ``catch`` block:

Set a breakpoint on ``catch (DbUpdateConcurrencyException)``.

Select ``Edit`` for a movie, make changes, but don't enter **Save**.

In another browser window, select the **Delete** link for the same movie, and then delete the movie.

In the previous browser window, post changes to the movie.

Production code may want to detect concurrency conflicts. See [[Handle concurrency] conflicts](https://learn.microsoft.com/en-us/aspnet/core/data/ef-rp/concurrency?view=aspnetcore-9.0) for more information.

## Posting and binding review

Examine the ``Pages/Movies/Edit.cshtml.cs`` file:

```bash
public class EditModel : PageModel
{
    private readonly RazorPagesMovie.Data.RazorPagesMovieContext _context;

    public EditModel(RazorPagesMovie.Data.RazorPagesMovieContext context)
    {
        _context = context;
    }

    [BindProperty]
    public Movie Movie { get; set; } = default!;

    public async Task<IActionResult> OnGetAsync(int? id)
    {
        if (id == null)
        {
            return NotFound();
        }

        var movie =  await _context.Movie.FirstOrDefaultAsync(m => m.Id == id);
        if (movie == null)
        {
            return NotFound();
        }
        Movie = movie;
        return Page();
    }

    // To protect from overposting attacks, enable the specific properties you want to bind to.
    // For more details, see https://aka.ms/RazorPagesCRUD.
    public async Task<IActionResult> OnPostAsync()
    {
        if (!ModelState.IsValid)
        {
            return Page();
        }

        _context.Attach(Movie).State = EntityState.Modified;

        try
        {
            await _context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!MovieExists(Movie.Id))
            {
                return NotFound();
            }
            else
            {
                throw;
            }
        }

        return RedirectToPage("./Index");
    }

    private bool MovieExists(int id)
    {
        return _context.Movie.Any(e => e.Id == id);
    }
```

When an ``HTTP GET`` request is made to the ``Movies/Edit page``, for example, ``https://localhost:5001/Movies/Edit/3``:

The ``OnGetAsync`` method fetches the movie from the database and returns the ``Page`` method.

The ``Page`` method renders the ``Pages/Movies/Edit.cshtml`` Razor Page. The ``Pages/Movies/Edit.cshtml`` file contains the model directive ``@model RazorPagesMovie.Pages.Movies.EditModel``, which makes the ``movie`` model available on the page.

The Edit form is displayed with the values from the movie.

When the ``Movies/Edit`` page is posted:

The form values on the page are bound to the ``Movie`` property. The ``[BindProperty]`` attribute enables Model binding.

```bash
    [BindProperty]
    public Movie Movie { get; set; }
```

If there are errors in the model state, for example, ``ReleaseDate`` cannot be converted to a date, the form is redisplayed with the submitted values.

If there are no model errors, the movie is saved.

The HTTP GET methods in the **Index**, **Create**, and **Delete** Razor pages follow a similar pattern. The HTTP POST ``OnPostAsync`` method in the ``Create`` Razor Page follows a similar pattern to the ``OnPostAsync`` method in the ``Edit`` Razor Page.
